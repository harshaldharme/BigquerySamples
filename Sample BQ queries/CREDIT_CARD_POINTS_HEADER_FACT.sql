--DDL
bq mk -t ulta_work.CREDIT_CARD_POINTS_HEADER_FACT CREDIT_CARD_POINTS_HEADER_KEY:INTEGER,RECEIPT_BASE:FLOAT,RECEIPT_BONUS:FLOAT,RECEIPT_DEDUCTION:FLOAT,RECEIPT_GROSS:FLOAT,RECEIPT_NET:FLOAT,SETTLEMENT_AMOUNT:FLOAT,LOYALTY_ACCOUNT_KEY:INTEGER,INDIVIDUAL_KEY:INTEGER,REGISTER_ID:INTEGER,SALES_HEADER_KEY:INTEGER,TRANSACTION_NUMBER:INTEGER,TRANSACTION_ID:INTEGER,CREDIT_CARD_TYPE:STRING,MERCHANT_NAME:STRING,WEB_ORDER_NUMBER:STRING,PROGRAM_MASTER_ID:STRING,STORE_KEY:INTEGER,TIER_NAME:STRING,TRANSACTION_STATUS:STRING,CREATED_TIMESTAMP:TIMESTAMP,LAST_MODIFIED_TIMESTAMP:TIMESTAMP,TRANSACTION_DATE:DATE,INDIVIDUAL_ID:STRING,MERCHANT_NUMBER:STRING,MERCHANT_CATEGORY:STRING,DESCRIPTION_CODE:STRING,STORE_ID:STRING,CREDIT_CARD_TRANSACTION_ID:INTEGER


bq mk -t ulta_work.CREDIT_CARD_POINTS_HEADER_FACT_UNCHANGED CREDIT_CARD_POINTS_HEADER_KEY:INTEGER,RECEIPT_BASE:FLOAT,RECEIPT_BONUS:FLOAT,RECEIPT_DEDUCTION:FLOAT,RECEIPT_GROSS:FLOAT,RECEIPT_NET:FLOAT,SETTLEMENT_AMOUNT:FLOAT,LOYALTY_ACCOUNT_KEY:INTEGER,INDIVIDUAL_KEY:INTEGER,REGISTER_ID:INTEGER,SALES_HEADER_KEY:INTEGER,TRANSACTION_NUMBER:INTEGER,TRANSACTION_ID:INTEGER,CREDIT_CARD_TYPE:STRING,MERCHANT_NAME:STRING,WEB_ORDER_NUMBER:STRING,PROGRAM_MASTER_ID:STRING,STORE_KEY:INTEGER,TIER_NAME:STRING,TRANSACTION_STATUS:STRING,CREATED_TIMESTAMP:TIMESTAMP,LAST_MODIFIED_TIMESTAMP:TIMESTAMP,TRANSACTION_DATE:DATE,INDIVIDUAL_ID:STRING,MERCHANT_NUMBER:STRING,MERCHANT_CATEGORY:STRING,DESCRIPTION_CODE:STRING,STORE_ID:STRING,CREDIT_CARD_TRANSACTION_ID:INTEGER

bq mk -t ulta_work.CREDIT_CARD_POINTS_HEADER_FACT_UPDATED CREDIT_CARD_POINTS_HEADER_KEY:INTEGER,RECEIPT_BASE:FLOAT,RECEIPT_BONUS:FLOAT,RECEIPT_DEDUCTION:FLOAT,RECEIPT_GROSS:FLOAT,RECEIPT_NET:FLOAT,SETTLEMENT_AMOUNT:FLOAT,LOYALTY_ACCOUNT_KEY:INTEGER,INDIVIDUAL_KEY:INTEGER,REGISTER_ID:INTEGER,SALES_HEADER_KEY:INTEGER,TRANSACTION_NUMBER:INTEGER,TRANSACTION_ID:INTEGER,CREDIT_CARD_TYPE:STRING,MERCHANT_NAME:STRING,WEB_ORDER_NUMBER:STRING,PROGRAM_MASTER_ID:STRING,STORE_KEY:INTEGER,TIER_NAME:STRING,TRANSACTION_STATUS:STRING,CREATED_TIMESTAMP:TIMESTAMP,LAST_MODIFIED_TIMESTAMP:TIMESTAMP,TRANSACTION_DATE:DATE,INDIVIDUAL_ID:STRING,MERCHANT_NUMBER:STRING,MERCHANT_CATEGORY:STRING,DESCRIPTION_CODE:STRING,STORE_ID:STRING,CREDIT_CARD_TRANSACTION_ID:INTEGER

bq mk -t ulta_mart.CREDIT_CARD_POINTS_HEADER_FACT CREDIT_CARD_POINTS_HEADER_KEY:INTEGER,RECEIPT_BASE:FLOAT,RECEIPT_BONUS:FLOAT,RECEIPT_DEDUCTION:FLOAT,RECEIPT_GROSS:FLOAT,RECEIPT_NET:FLOAT,SETTLEMENT_AMOUNT:FLOAT,LOYALTY_ACCOUNT_KEY:INTEGER,INDIVIDUAL_KEY:INTEGER,REGISTER_ID:INTEGER,SALES_HEADER_KEY:INTEGER,TRANSACTION_NUMBER:INTEGER,TRANSACTION_ID:INTEGER,CREDIT_CARD_TYPE:STRING,MERCHANT_NAME:STRING,WEB_ORDER_NUMBER:STRING,PROGRAM_MASTER_ID:STRING,STORE_KEY:INTEGER,TIER_NAME:STRING,TRANSACTION_STATUS:STRING,CREATED_TIMESTAMP:TIMESTAMP,LAST_MODIFIED_TIMESTAMP:TIMESTAMP,TRANSACTION_DATE:DATE,INDIVIDUAL_ID:STRING,MERCHANT_NUMBER:STRING,MERCHANT_CATEGORY:STRING,DESCRIPTION_CODE:STRING,STORE_ID:STRING,CREDIT_CARD_TRANSACTION_ID:INTEGER


--1. Step to insert in to stage table
DELETE ulta_work.CREDIT_CARD_POINTS_HEADER_FACT WHERE TRUE

insert into ulta_work.CREDIT_CARD_POINTS_HEADER_FACT (CREDIT_CARD_POINTS_HEADER_KEY,RECEIPT_BASE,RECEIPT_BONUS,RECEIPT_DEDUCTION,RECEIPT_GROSS,RECEIPT_NET,SETTLEMENT_AMOUNT,LOYALTY_ACCOUNT_KEY,INDIVIDUAL_KEY,REGISTER_ID,SALES_HEADER_KEY,TRANSACTION_NUMBER,TRANSACTION_ID,CREDIT_CARD_TYPE,MERCHANT_NAME,WEB_ORDER_NUMBER,PROGRAM_MASTER_ID,STORE_KEY,TIER_NAME,TRANSACTION_STATUS,CREATED_TIMESTAMP,LAST_MODIFIED_TIMESTAMP,TRANSACTION_DATE,INDIVIDUAL_ID,MERCHANT_NUMBER,MERCHANT_CATEGORY,DESCRIPTION_CODE,STORE_ID,CREDIT_CARD_TRANSACTION_ID)
select 
NULL AS CREDIT_CARD_POINTS_HEADER_KEY,--keys will be populated--'SALES INTERACTIONS-CREDIT CARD-POINTS HEADER-'||NVL(ICREDITCARDTRANSACTIONID::VARCHAR(100),'') as CREDIT_CARD_POINTS_HEADER_KEY,
CREDITCARDPOINTSHEADER.DRECEIPTBASE as RECEIPT_BASE,
CREDITCARDPOINTSHEADER.DRECEIPTBONUS as RECEIPT_BONUS,
CREDITCARDPOINTSHEADER.DRECEIPTNET as RECEIPT_NET,
CREDITCARDPOINTSHEADER.DRECEIPTDEDUCTION as RECEIPT_DEDUCTION,
CREDITCARDPOINTSHEADER.DRECEIPTGROSS as RECEIPT_GROSS,
CREDITCARDPOINTSHEADER.DSETTLEMENTAMOUNT as SETTLEMENT_AMOUNT,
NULL AS LOYALTY_ACCOUNT_KEY,-- LOYALTY_ACCOUNT_NK Will be populate later--'CUSTOMER-LOYALTY-ACCOUNT-'||NVL(ICUSTOMERID::VARCHAR(100),'') as LOYALTY_ACCOUNT_KEY,
NULL AS INDIVIDUAL_KEY,--NK will be populate later --'CUSTOMER-INDIVIDUAL-'||NVL(IRECIPIENTID::VARCHAR(100),'') as INDIVIDUAL_KEY
CREDITCARDPOINTSHEADER.IREGID as REGISTER_ID,
NULL as SALES_HEADER_KEY ,--blank in STM
CREDITCARDPOINTSHEADER.ITRANNUM as TRANSACTION_NUMBER,
CREDITCARDPOINTSHEADER.ITRANSACTIONID as TRANSACTION_ID,
SCREDITCARDTYPE as CREDIT_CARD_TYPE,--blank in stm BUT FROM DISCUSSION  TAKE FROM LAND but taking directly from land
SMERCHANTNAME as MERCHANT_NAME,--blank in stm BUT FROM DISCUSSION  TAKE FROM LAND but taking directly from land
CREDITCARDPOINTSHEADER.SORDERNUM as WEB_ORDER_NUMBER,
SPROGRAMMASTERID as PROGRAM_MASTER_ID,--blank in stm BUT FROM DISCUSSION  TAKE FROM LAND but taking directly from land
NULL AS STORE_KEY,--STORE_NK keys will be populated 'LOCATION-STORE-'||NVL(SSTORENUM,'') as STORE_KEY,
STIERNAME as TIER_NAME,--blank in stm BUT FROM DISCUSSION  TAKE FROM LAND but taking directly from land
STRANSACTIONSTATUS as TRANSACTION_STATUS,--blank in stm can we take from land? as data not matched in mart and land --after discussion from land
CREDITCARDPOINTSHEADER.TSCREATED as CREATED_TIMESTAMP,
CREDITCARDPOINTSHEADER.TSLASTMODIFIED as LAST_MODIFIED_TIMESTAMP,
CAST(CREDITCARDPOINTSHEADER.TSTRANDATE AS DATE) as TRANSACTION_DATE,
CAST(IRECIPIENTID AS STRING) AS INDIVIDUAL_ID,--blank IN STM BUT FROM DISCUSSION  TAKE FROM LAND but taking directly from land
SMERCHANTNUMBER as MERCHANT_NUMBER,--blank IN STM BUT FROM DISCUSSION  TAKE FROM LAND but taking directly from land
SMERCHANTCATEGORY as MERCHANT_CATEGORY,--blank IN STM BUT FROM DISCUSSION  TAKE FROM LAND but taking directly from land
CREDITCARDPOINTSHEADER.SDESCRIPTIONCODE as DESCRIPTION_CODE,
SSTORENUM as STORE_ID, --BLANK IN STM AND FROM MULTIPLE SOURCES AND DERIVED ATTRIBUTE but taking directly from land
ICREDITCARDTRANSACTIONID AS CREDIT_CARD_TRANSACTION_ID
from ulta_incoming.CREDITCARDPOINTSHEADER as CREDITCARDPOINTSHEADER where ICREDITCARDTRANSACTIONID is not null and ICREDITCARDTRANSACTIONID <> 0;


--2. populate unchanged and updated stage table
DELETE ulta_work.CREDIT_CARD_POINTS_HEADER_FACT_UNCHANGED WHERE TRUE

insert into ulta_work.CREDIT_CARD_POINTS_HEADER_FACT_UNCHANGED (CREDIT_CARD_POINTS_HEADER_KEY,RECEIPT_BASE,RECEIPT_BONUS,RECEIPT_DEDUCTION,RECEIPT_GROSS,RECEIPT_NET,SETTLEMENT_AMOUNT,LOYALTY_ACCOUNT_KEY,INDIVIDUAL_KEY,REGISTER_ID,SALES_HEADER_KEY,TRANSACTION_NUMBER,TRANSACTION_ID,CREDIT_CARD_TYPE,MERCHANT_NAME,WEB_ORDER_NUMBER,PROGRAM_MASTER_ID,STORE_KEY,TIER_NAME,TRANSACTION_STATUS,CREATED_TIMESTAMP,LAST_MODIFIED_TIMESTAMP,TRANSACTION_DATE,INDIVIDUAL_ID,MERCHANT_NUMBER,MERCHANT_CATEGORY,DESCRIPTION_CODE,STORE_ID,CREDIT_CARD_TRANSACTION_ID)
select mart.CREDIT_CARD_POINTS_HEADER_KEY,mart.RECEIPT_BASE,mart.RECEIPT_BONUS,mart.RECEIPT_DEDUCTION,mart.RECEIPT_GROSS,mart.RECEIPT_NET,mart.SETTLEMENT_AMOUNT,mart.LOYALTY_ACCOUNT_KEY,mart.INDIVIDUAL_KEY,mart.REGISTER_ID,mart.SALES_HEADER_KEY,mart.TRANSACTION_NUMBER,mart.TRANSACTION_ID,mart.CREDIT_CARD_TYPE,mart.MERCHANT_NAME,mart.WEB_ORDER_NUMBER,mart.PROGRAM_MASTER_ID,mart.STORE_KEY,mart.TIER_NAME,mart.TRANSACTION_STATUS,mart.CREATED_TIMESTAMP,mart.LAST_MODIFIED_TIMESTAMP,mart.TRANSACTION_DATE,mart.INDIVIDUAL_ID,mart.MERCHANT_NUMBER,mart.MERCHANT_CATEGORY,mart.DESCRIPTION_CODE,mart.STORE_ID,mart.CREDIT_CARD_TRANSACTION_ID
FROM ulta_mart.CREDIT_CARD_POINTS_HEADER_FACT mart LEFT OUTER JOIN ulta_work.CREDIT_CARD_POINTS_HEADER_FACT stage 
ON  mart.CREDIT_CARD_TRANSACTION_ID=stage.CREDIT_CARD_TRANSACTION_ID
where stage.CREDIT_CARD_TRANSACTION_ID is null


DELETE ulta_work.CREDIT_CARD_POINTS_HEADER_FACT_UPDATED WHERE TRUE

insert into ulta_work.CREDIT_CARD_POINTS_HEADER_FACT_UPDATED (CREDIT_CARD_POINTS_HEADER_KEY,RECEIPT_BASE,RECEIPT_BONUS,RECEIPT_DEDUCTION,RECEIPT_GROSS,RECEIPT_NET,SETTLEMENT_AMOUNT,LOYALTY_ACCOUNT_KEY,INDIVIDUAL_KEY,REGISTER_ID,SALES_HEADER_KEY,TRANSACTION_NUMBER,TRANSACTION_ID,CREDIT_CARD_TYPE,MERCHANT_NAME,WEB_ORDER_NUMBER,PROGRAM_MASTER_ID,STORE_KEY,TIER_NAME,TRANSACTION_STATUS,CREATED_TIMESTAMP,LAST_MODIFIED_TIMESTAMP,TRANSACTION_DATE,INDIVIDUAL_ID,MERCHANT_NUMBER,MERCHANT_CATEGORY,DESCRIPTION_CODE,STORE_ID,CREDIT_CARD_TRANSACTION_ID)
select mart.CREDIT_CARD_POINTS_HEADER_KEY,stage.RECEIPT_BASE,stage.RECEIPT_BONUS,stage.RECEIPT_DEDUCTION,stage.RECEIPT_GROSS,stage.RECEIPT_NET,stage.SETTLEMENT_AMOUNT,stage.LOYALTY_ACCOUNT_KEY,stage.INDIVIDUAL_KEY,stage.REGISTER_ID,stage.SALES_HEADER_KEY,stage.TRANSACTION_NUMBER,stage.TRANSACTION_ID,stage.CREDIT_CARD_TYPE,stage.MERCHANT_NAME,stage.WEB_ORDER_NUMBER,stage.PROGRAM_MASTER_ID,stage.STORE_KEY,stage.TIER_NAME,stage.TRANSACTION_STATUS,stage.CREATED_TIMESTAMP,stage.LAST_MODIFIED_TIMESTAMP,stage.TRANSACTION_DATE,stage.INDIVIDUAL_ID,stage.MERCHANT_NUMBER,stage.MERCHANT_CATEGORY,stage.DESCRIPTION_CODE,stage.STORE_ID,stage.CREDIT_CARD_TRANSACTION_ID
FROM ulta_mart.CREDIT_CARD_POINTS_HEADER_FACT mart INNER JOIN ulta_work.CREDIT_CARD_POINTS_HEADER_FACT stage 
ON mart.CREDIT_CARD_TRANSACTION_ID = stage.CREDIT_CARD_TRANSACTION_ID


--3. delete data from mart and take back up
bq cp ulta_mart.CREDIT_CARD_POINTS_HEADER_FACT ulta_mart.CREDIT_CARD_POINTS_HEADER_FACT_20180726
DELETE ulta_mart.CREDIT_CARD_POINTS_HEADER_FACT WHERE TRUE


--4. Populate mart table 

insert into ulta_mart.CREDIT_CARD_POINTS_HEADER_FACT (CREDIT_CARD_POINTS_HEADER_KEY,RECEIPT_BASE,RECEIPT_BONUS,RECEIPT_DEDUCTION,RECEIPT_GROSS,RECEIPT_NET,SETTLEMENT_AMOUNT,LOYALTY_ACCOUNT_KEY,INDIVIDUAL_KEY,REGISTER_ID,SALES_HEADER_KEY,TRANSACTION_NUMBER,TRANSACTION_ID,CREDIT_CARD_TYPE,MERCHANT_NAME,WEB_ORDER_NUMBER,PROGRAM_MASTER_ID,STORE_KEY,TIER_NAME,TRANSACTION_STATUS,CREATED_TIMESTAMP,LAST_MODIFIED_TIMESTAMP,TRANSACTION_DATE,INDIVIDUAL_ID,MERCHANT_NUMBER,MERCHANT_CATEGORY,DESCRIPTION_CODE,STORE_ID,CREDIT_CARD_TRANSACTION_ID)
SELECT
NULL AS CREDIT_CARD_POINTS_HEADER_KEY,stage.RECEIPT_BASE,stage.RECEIPT_BONUS,stage.RECEIPT_DEDUCTION,stage.RECEIPT_GROSS,stage.RECEIPT_NET,stage.SETTLEMENT_AMOUNT,stage.LOYALTY_ACCOUNT_KEY,stage.INDIVIDUAL_KEY,stage.REGISTER_ID,stage.SALES_HEADER_KEY,stage.TRANSACTION_NUMBER,stage.TRANSACTION_ID,stage.CREDIT_CARD_TYPE,stage.MERCHANT_NAME,stage.WEB_ORDER_NUMBER,stage.PROGRAM_MASTER_ID,stage.STORE_KEY,stage.TIER_NAME,stage.TRANSACTION_STATUS,stage.CREATED_TIMESTAMP,stage.LAST_MODIFIED_TIMESTAMP,stage.TRANSACTION_DATE,stage.INDIVIDUAL_ID,stage.MERCHANT_NUMBER,stage.MERCHANT_CATEGORY,stage.DESCRIPTION_CODE,stage.STORE_ID,stage.CREDIT_CARD_TRANSACTION_ID
FROM ulta_work.CREDIT_CARD_POINTS_HEADER_FACT stage 
LEFT JOIN ulta_work.CREDIT_CARD_POINTS_HEADER_FACT_UPDATED updated
ON stage.CREDIT_CARD_TRANSACTION_ID=updated.CREDIT_CARD_TRANSACTION_ID
where updated.CREDIT_CARD_TRANSACTION_ID is NULL
UNION ALL
select CREDIT_CARD_POINTS_HEADER_KEY,RECEIPT_BASE,RECEIPT_BONUS,RECEIPT_DEDUCTION,RECEIPT_GROSS,RECEIPT_NET,SETTLEMENT_AMOUNT,LOYALTY_ACCOUNT_KEY,INDIVIDUAL_KEY,REGISTER_ID,SALES_HEADER_KEY,TRANSACTION_NUMBER,TRANSACTION_ID,CREDIT_CARD_TYPE,MERCHANT_NAME,WEB_ORDER_NUMBER,PROGRAM_MASTER_ID,STORE_KEY,TIER_NAME,TRANSACTION_STATUS,CREATED_TIMESTAMP,LAST_MODIFIED_TIMESTAMP,TRANSACTION_DATE,INDIVIDUAL_ID,MERCHANT_NUMBER,MERCHANT_CATEGORY,DESCRIPTION_CODE,STORE_ID,CREDIT_CARD_TRANSACTION_ID
from ulta_work.CREDIT_CARD_POINTS_HEADER_FACT_UPDATED
UNION ALL
select CREDIT_CARD_POINTS_HEADER_KEY,RECEIPT_BASE,RECEIPT_BONUS,RECEIPT_DEDUCTION,RECEIPT_GROSS,RECEIPT_NET,SETTLEMENT_AMOUNT,LOYALTY_ACCOUNT_KEY,INDIVIDUAL_KEY,REGISTER_ID,SALES_HEADER_KEY,TRANSACTION_NUMBER,TRANSACTION_ID,CREDIT_CARD_TYPE,MERCHANT_NAME,WEB_ORDER_NUMBER,PROGRAM_MASTER_ID,STORE_KEY,TIER_NAME,TRANSACTION_STATUS,CREATED_TIMESTAMP,LAST_MODIFIED_TIMESTAMP,TRANSACTION_DATE,INDIVIDUAL_ID,MERCHANT_NUMBER,MERCHANT_CATEGORY,DESCRIPTION_CODE,STORE_ID,CREDIT_CARD_TRANSACTION_ID
from ulta_work.CREDIT_CARD_POINTS_HEADER_FACT_UNCHANGED